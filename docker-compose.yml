# Certificate_Study - Frontend, Backend, SFU
# EC2에서: 이미지 빌드 후 docker compose up -d 또는 이미지 pull 후 run

version: "3.8"

services:
  backend:
    build:
      context: ./Backend
      dockerfile: Dockerfile
    image: certificate-study/backend:latest
    container_name: backend
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - RDS_HOSTNAME=${RDS_HOSTNAME}
      - RDS_USERNAME=${RDS_USERNAME}
      - RDS_PASSWORD=${RDS_PASSWORD}
      - KAKAO_CLIENT_ID=${KAKAO_CLIENT_ID}
      - KAKAO_CLIENT_SECRET=${KAKAO_CLIENT_SECRET}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - NAVER_CLIENT_ID=${NAVER_CLIENT_ID}
      - NAVER_CLIENT_SECRET=${NAVER_CLIENT_SECRET}
      - AWS_ACCESS_KEY=${AWS_ACCESS_KEY}
      - AWS_SECRET_KEY=${AWS_SECRET_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    ports:
      - "8080:8080"
    networks:
      - app

  frontend:
    build:
      context: ./Frontend
      dockerfile: Dockerfile
      args:
        # 같은 호스트에서 접속 시 빌드 시 지정 불필요 (window.location 사용)
        # REACT_APP_BACKEND_ORIGIN: https://onsil.study
        # REACT_APP_SFU_WS_HOST: onsil.study
    image: certificate-study/frontend:latest
    container_name: frontend
    restart: unless-stopped
    ports:
      - "3000:80"
    depends_on:
      - backend
    networks:
      - app

  sfu:
    build:
      context: ./SFU
      dockerfile: Dockerfile
    image: certificate-study/sfu:latest
    container_name: sfu
    restart: unless-stopped
    environment:
      # EC2 공인 IP 또는 도메인 (WebRTC ICE에 노출)
      - ANNOUNCED_IP=${ANNOUNCED_IP:-}
    ports:
      - "4000:4000"
      # mediasoup WebRTC 포트 (UDP/TCP)
      - "40000-49999:40000-49999/udp"
      - "40000-49999:40000-49999/tcp"
    networks:
      - app

networks:
  app:
    driver: bridge
