<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.마이페이지.mapper.MyPageMapper">

    <!-- 내 정보 조회 -->
    <select id="findByUserId" resultType="com.example.demo.마이페이지.vo.MyPageVO">
        SELECT *
        FROM users
        WHERE user_id = #{userId}
    </select>

    <!-- 내 정보 수정 -->
    <update id="updateMyPage">
        UPDATE users
        SET name = #{name},
            nickname = #{nickname},
            birth_date = #{birthDate},
            gender = #{gender},
            introduction = #{introduction},
            profile_img = #{profileImg}
        WHERE user_id = #{userId}
    </update>


    <!-- 회원 탈퇴 -->
    <delete id="deleteByEmail">
        DELETE FROM users
        WHERE email = #{email}
    </delete>

    <!-- 성별 조회 -->
    <select id="getGender" resultType="String">
        SELECT gender
        FROM users
        WHERE email = #{email}
    </select>

    <!-- 진행중 스터디 -->
    <select id="getJoinedStudies" resultType="com.example.demo.마이페이지.vo.MyStudyVO">

        <!-- 방장이 만든 진행중 -->
        SELECT r.room_id AS roomId,
        r.title,
        '진행중' AS status,
        r.start_date AS startDate,
        r.ended_at AS endAt,
        r.host_user_email AS hostEmail
        FROM room r
        WHERE r.host_user_email = #{email}
        AND r.ended_at <![CDATA[ >= ]]> CURDATE()

        UNION

        <!-- 가입 승인된 진행중 (방장인 방은 위에서 이미 포함되므로 제외 → 스터디장 위임 시 중복 방지) -->
        SELECT r.room_id AS roomId,
        r.title,
        '진행중' AS status,
        r.start_date AS startDate,
        r.ended_at AS endAt,
        r.host_user_email AS hostEmail
        FROM room_join_request j
        JOIN room r ON j.room_id = r.room_id
        WHERE j.request_user_email = #{email}
        AND j.status = '승인'
        AND r.host_user_email != #{email}
        AND r.ended_at <![CDATA[ >= ]]> CURDATE()

    </select>

    <!-- 완료된 스터디 -->
    <select id="getCompletedStudies" resultType="com.example.demo.마이페이지.vo.MyStudyVO">

        <!-- 방장이 만든 종료 -->
        SELECT r.room_id AS roomId,
        r.title,
        '종료' AS status,
        r.start_date AS startDate,
        r.ended_at AS endAt,
        r.host_user_email AS hostEmail
        FROM room r
        WHERE r.host_user_email = #{email}
        AND r.ended_at <![CDATA[ < ]]> CURDATE()

        UNION

        <!-- 가입 승인된 종료 (방장인 방은 위에서 이미 포함되므로 제외 → 스터디장 위임 시 중복 방지) -->
        SELECT r.room_id AS roomId,
        r.title,
        '종료' AS status,
        r.start_date AS startDate,
        r.ended_at AS endAt,
        r.host_user_email AS hostEmail
        FROM room_join_request j
        JOIN room r ON j.room_id = r.room_id
        WHERE j.request_user_email = #{email}
        AND j.status = '승인'
        AND r.host_user_email != #{email}
        AND r.ended_at <![CDATA[ < ]]> CURDATE()

    </select>

</mapper>
