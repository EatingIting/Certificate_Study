<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.마이페이지.mapper.MyPageMapper">

    <!-- 내 정보 조회 -->
    <select id="findByUserId" resultType="com.example.demo.마이페이지.vo.MyPageVO">
        SELECT *
        FROM users
        WHERE user_id = #{userId}
    </select>

    <!-- 내 정보 수정 -->
    <update id="updateMyPage">
        UPDATE users
        SET name = #{name},
            nickname = #{nickname},
            birth_date = #{birthDate},
            gender = #{gender},
            introduction = #{introduction},
            profile_img = #{profileImg}
        WHERE user_id = #{userId}
    </update>

    <!-- 방장 여부 체크 -->
    <select id="countRoomsByHost" resultType="int">
        SELECT COUNT(*)
        FROM room
        WHERE host_user_email = #{email}
    </select>

    <!-- 회원탈퇴용 FK 삭제 (user_id 기준) -->

    <delete id="deleteBoardCommentsByUser">
        DELETE FROM board_comments
        WHERE user_id = #{userId}
    </delete>

    <delete id="deleteBoardPostsByUser">
        DELETE FROM board_posts
        WHERE user_id = #{userId}
    </delete>

    <delete id="deleteChatMessagesByUser">
        DELETE FROM chat_messages
        WHERE user_id = #{userId}
    </delete>

    <delete id="deleteChatParticipantsByUser">
        DELETE FROM chat_participants
        WHERE user_id = #{userId}
    </delete>

    <delete id="deleteSchedulesByUser">
        DELETE FROM schedules
        WHERE user_id = #{userId}
    </delete>

    <delete id="deleteUserInterestCategory">
        DELETE FROM user_interest_category
        WHERE user_id = #{userId}
    </delete>

    <!-- 회원탈퇴용 FK 삭제 (email 기준) -->
    <delete id="deleteJoinRequestByRequester">
        DELETE FROM room_join_request
        WHERE request_user_email = #{email}
    </delete>

    <delete id="deleteJoinRequestByHost">
        DELETE FROM room_join_request
        WHERE host_user_email = #{email}
    </delete>

    <!-- 마지막 users 삭제 -->
    <delete id="deleteUser">
        DELETE FROM users
        WHERE user_id = #{userId}
    </delete>

    <!-- 성별 조회 -->
    <select id="getGender" resultType="String">
        SELECT gender
        FROM users
        WHERE email = #{email}
    </select>

    <!-- 진행중 스터디 -->
    <select id="getJoinedStudies" resultType="com.example.demo.마이페이지.vo.MyStudyVO">

        SELECT r.room_id AS roomId,
               r.title,
               '진행중' AS status,
               r.start_date AS startDate,
               r.ended_at AS endAt,
               r.host_user_email AS hostEmail
        FROM room r
        WHERE r.host_user_email = #{email}
          AND r.ended_at <![CDATA[ >= ]]> CURDATE()

        UNION

        SELECT r.room_id AS roomId,
               r.title,
               '진행중' AS status,
               r.start_date AS startDate,
               r.ended_at AS endAt,
               r.host_user_email AS hostEmail
        FROM room_join_request j
                 JOIN room r ON j.room_id = r.room_id
        WHERE j.request_user_email = #{email}
          AND j.status = '승인'
          AND r.ended_at <![CDATA[ >= ]]> CURDATE()
        GROUP BY r.room_id, r.title, r.start_date, r.ended_at, r.host_user_email

    </select>

    <!-- 완료된 스터디 -->
    <select id="getCompletedStudies" resultType="com.example.demo.마이페이지.vo.MyStudyVO">

        SELECT r.room_id AS roomId,
               r.title,
               '종료' AS status,
               r.start_date AS startDate,
               r.ended_at AS endAt,
               r.host_user_email AS hostEmail
        FROM room r
        WHERE r.host_user_email = #{email}
          AND r.ended_at <![CDATA[ < ]]> CURDATE()

        UNION

        SELECT r.room_id AS roomId,
               r.title,
               '종료' AS status,
               r.start_date AS startDate,
               r.ended_at AS endAt,
               r.host_user_email AS hostEmail
        FROM room_join_request j
                 JOIN room r ON j.room_id = r.room_id
        WHERE j.request_user_email = #{email}
          AND j.status = '승인'
          AND r.ended_at <![CDATA[ < ]]> CURDATE()
        GROUP BY r.room_id, r.title, r.start_date, r.ended_at, r.host_user_email

    </select>

</mapper>
