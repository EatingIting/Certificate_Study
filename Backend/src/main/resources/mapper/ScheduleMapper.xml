<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.schedule.mapper.ScheduleMapper">

    <resultMap id="ScheduleMap" type="com.example.demo.schedule.vo.ScheduleVO">
        <id     property="scheduleId"        column="schedule_id"/>
        <result property="roomId"            column="room_id"/>
        <result property="userId"            column="user_id"/>
        <result property="title"             column="title"/>
        <result property="description"       column="description"/>
        <result property="startAt"           column="start_at"/>
        <result property="endAt"             column="end_at"/>
        <result property="type"              column="type"/>
        <result property="colorHex"          column="color_hex"/>
        <result property="textColor"         column="text_color"/>
        <result property="customTypeLabel"   column="custom_type_label"/>
        <result property="createdAt"         column="created_at"/>
        <result property="updatedAt"         column="updated_at"/>
        <result property="deletedAt"         column="deleted_at"/>
    </resultMap>

    <!--
      겹치는 일정 포함:
        start_at <= endInclusive AND end_at >= start
      endInclusive = DATE_SUB(endExclusive, INTERVAL 1 DAY)
    -->
    <select id="selectByRange" resultMap="ScheduleMap">
        SELECT
        schedule_id, room_id, user_id, title, description,
        start_at, end_at, type, color_hex, text_color, custom_type_label,
        created_at, updated_at, deleted_at
        FROM schedules
        WHERE room_id = #{roomId}
        AND deleted_at IS NULL
        AND start_at <![CDATA[<=]]> DATE_SUB(#{endExclusive}, INTERVAL 1 DAY)
        AND end_at   <![CDATA[>=]]> #{start}
        ORDER BY start_at ASC, schedule_id ASC
    </select>

    <insert id="insert" parameterType="com.example.demo.schedule.vo.ScheduleVO"
            useGeneratedKeys="true" keyProperty="scheduleId">
        INSERT INTO schedules (
        room_id, user_id, title, description,
        start_at, end_at, type, color_hex, text_color, custom_type_label
        ) VALUES (
        #{roomId}, #{userId}, #{title}, #{description},
        #{startAt}, #{endAt}, #{type}, #{colorHex}, #{textColor}, #{customTypeLabel}
        )
    </insert>

    <update id="update" parameterType="com.example.demo.schedule.vo.ScheduleVO">
        UPDATE schedules
        SET
        title = #{title},
        description = #{description},
        start_at = #{startAt},
        end_at = #{endAt},
        type = #{type},
        color_hex = #{colorHex},
        text_color = #{textColor},
        custom_type_label = #{customTypeLabel}
        WHERE schedule_id = #{scheduleId}
        AND room_id = #{roomId}
        AND user_id = #{userId}
        AND deleted_at IS NULL
    </update>

    <update id="softDelete">
        UPDATE schedules
        SET deleted_at = CURRENT_TIMESTAMP
        WHERE schedule_id = #{scheduleId}
        AND room_id = #{roomId}
        AND user_id = #{userId}
        AND deleted_at IS NULL
    </update>

</mapper>
