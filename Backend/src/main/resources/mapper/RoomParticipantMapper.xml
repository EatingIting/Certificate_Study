<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.roomparticipant.RoomParticipantMapper">

    <!-- 방장 이메일 -->
    <select id="selectHostEmail" resultType="string">
        SELECT host_user_email
        FROM room
        WHERE room_id = #{roomId}
    </select>

    <!-- 승인 멤버 목록 -->
    <select id="selectApprovedParticipants" resultType="com.example.demo.roomparticipant.RoomParticipantVO">
        SELECT
            u.user_id      AS userId,
            u.email        AS email,
            u.name         AS name,
            u.nickname     AS nickname,
            u.profile_img  AS profileImg,
            rjr.requested_at AS joinedAt
        FROM room_join_request rjr
                 JOIN users u
                      ON u.email = rjr.request_user_email
        WHERE rjr.room_id = #{roomId}
          AND rjr.status = '승인'
        ORDER BY rjr.requested_at DESC
    </select>

    <!-- 이메일로 유저 조회(호스트 보장용) -->
    <select id="selectUserByEmail" resultType="com.example.demo.roomparticipant.RoomParticipantVO">
        SELECT
            u.user_id      AS userId,
            u.email        AS email,
            u.name         AS name,
            u.nickname     AS nickname,
            u.profile_img  AS profileImg,
            NULL           AS joinedAt
        FROM users u
        WHERE u.email = #{email}
    </select>

    <!-- userId -> email -->
    <select id="selectEmailByUserId" resultType="string">
        SELECT email
        FROM users
        WHERE user_id = #{userId}
    </select>

    <!-- 승인 멤버인지 -->
    <select id="countApprovedByEmail" resultType="int">
        SELECT COUNT(*)
        FROM room_join_request
        WHERE room_id = #{roomId}
          AND request_user_email = #{email}
          AND status = '승인'
    </select>

    <!-- 강퇴/탈퇴: 승인행 삭제 -->
    <delete id="deleteApprovedByEmail">
        DELETE FROM room_join_request
        WHERE room_id = #{roomId}
          AND request_user_email = #{email}
          AND status = '승인'
    </delete>

    <!-- 방장 위임 -->
    <update id="updateHostEmail">
        UPDATE room
        SET host_user_email = #{newHostEmail}
        WHERE room_id = #{roomId}
    </update>

</mapper>
