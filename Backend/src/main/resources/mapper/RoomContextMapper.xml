<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.roomcontext.RoomContextMapper">

    <resultMap id="RoomBasicMap" type="com.example.demo.roomcontext.RoomBasicVO">
        <result property="roomId" column="room_id"/>
        <result property="title" column="title"/>
        <result property="hostUserEmail" column="host_user_email"/>
    </resultMap>

    <select id="selectRoomBasic" resultMap="RoomBasicMap">
        SELECT
            room_id,
            title,
            host_user_email
        FROM room
        WHERE room_id = #{roomId}
    </select>

    <select id="countApprovedMember" resultType="int">
        SELECT COUNT(*)
        FROM room_join_request
        WHERE room_id = #{roomId}
          AND request_user_email = #{email}
          AND status = '승인'
    </select>

    <select id="selectLatestLeaveReason" resultType="string">
        SELECT reason
        FROM room_leave_history
        WHERE room_id = #{roomId}
          AND user_email = #{email}
        ORDER BY left_at DESC
        LIMIT 1
    </select>

    <select id="selectFallbackHostEmail" resultType="string">
        SELECT MIN(request_user_email)
        FROM room_join_request
        WHERE room_id = #{roomId}
          AND status = '승인'
        LIMIT 1
    </select>

</mapper>
