<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.application.ApplicationMapper">

    <!-- 신청 받은 스터디 -->
    <select id="selectReceivedApplications"
            resultType="com.example.demo.application.ApplicationVO">
        SELECT
        rjr.join_id                  AS joinId,
        rjr.room_id                  AS roomId,
        r.title                      AS studyTitle,

        rjr.request_user_nickname    AS applicantNickname,

        rjr.apply_message            AS applyMessage,
        rjr.requested_at             AS requestedAt,

        u.gender                     AS gender,
        TIMESTAMPDIFF(YEAR, u.birth_date, CURDATE()) AS age

        FROM room_join_request rjr
        JOIN room r
        ON rjr.room_id = r.room_id
        JOIN users u
        ON rjr.request_user_email = u.email

        WHERE rjr.host_user_email = #{hostUserEmail}
        AND rjr.status = '신청중'

        ORDER BY rjr.requested_at DESC
    </select>

    <!-- 내가 신청한 스터디 -->
    <select id="selectSentApplications"
            resultType="com.example.demo.application.ApplicationVO">
        SELECT
            rjr.join_id            AS joinId,
            rjr.room_id            AS roomId,
            r.title                AS studyTitle,
            u.nickname             AS ownerNickname,
            rjr.status             AS status,
            rjr.requested_at       AS requestedAt
        FROM room_join_request rjr
                 JOIN room r
                      ON rjr.room_id = r.room_id
                 JOIN users u
                      ON rjr.host_user_email = u.email
        WHERE rjr.request_user_email = #{requestUserEmail}
        ORDER BY rjr.requested_at DESC
    </select>

    <!-- 승인 -->
    <update id="approveApplication">
        UPDATE room_join_request
        SET status = '승인'
        WHERE join_id = #{joinId}
          AND host_user_email = #{hostUserEmail}
    </update>

    <!-- 거절 -->
    <update id="rejectApplication">
        UPDATE room_join_request
        SET status = '거절'
        WHERE join_id = #{joinId}
          AND host_user_email = #{hostUserEmail}
    </update>

    <!-- 신청 -->
    <insert id="insertApplication">
        INSERT INTO room_join_request (
        join_id,
        request_user_email,
        request_user_nickname,
        host_user_email,
        room_id,
        status,
        apply_message,
        requested_at
        )
        SELECT
        #{joinId},
        #{requestUserEmail},
        #{requestUserNickname},
        r.host_user_email,
        #{roomId},
        '신청중',
        #{applyMessage},
        NOW()
        FROM room r
        WHERE r.room_id = #{roomId}

        <!-- ✅ 본인이 만든 방이면 신청 불가 -->
        AND r.host_user_email != #{requestUserEmail}
    </insert>

    <!--  중복여부  -->
    <select id="existsActiveApplication" resultType="int">
        SELECT COUNT(*)
        FROM room_join_request
        WHERE room_id = #{roomId}
          AND request_user_email = #{requestUserEmail}
          AND status IN ('신청중', '승인')
    </select>



</mapper>
