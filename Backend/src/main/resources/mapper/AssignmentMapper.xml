<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.assignment.mapper.AssignmentMapper">

    <!-- 1) 과제 목록: 내 제출 여부로 status 만들기 -->
    <select id="selectAssignmentsByRoom" resultType="com.example.demo.assignment.dto.AssignmentListResponse">
        SELECT
            a.assignment_id AS assignmentId,
            a.title AS title,
            a.due_at AS dueAt,
            a.created_by_email AS authorEmail,
            CASE WHEN s.submission_id IS NULL THEN '제출 하기' ELSE '제출 완료' END AS status
        FROM assignments a
                 LEFT JOIN assignment_submissions s
                           ON s.assignment_id = a.assignment_id
                               AND s.user_email = #{userEmail}
        WHERE a.room_id = #{roomId}
        ORDER BY a.due_at ASC, a.assignment_id DESC
    </select>



    <!-- 2) 과제 생성 -->
    <insert id="insertAssignment"
            parameterType="com.example.demo.assignment.vo.AssignmentVO"
            useGeneratedKeys="true"
            keyProperty="assignmentId">

        INSERT INTO assignments (room_id, title, description, due_at, created_by_email)
        VALUES (#{roomId}, #{title}, #{description}, #{dueAt}, #{createdByEmail})

    </insert>


    <!-- 3) 제출: (assignment_id, user_email) UNIQUE라서 중복제출이면 UPDATE -->
    <insert id="upsertSubmission" parameterType="com.example.demo.assignment.vo.AssignmentSubmissionVO">
        INSERT INTO assignment_submissions
        (assignment_id, user_email, submit_title, memo, file_name, file_url, file_size, submitted_at)
        VALUES
            (#{assignmentId}, #{userEmail}, #{submitTitle}, #{memo}, #{fileName}, #{fileUrl}, #{fileSize}, CURRENT_TIMESTAMP)
            ON DUPLICATE KEY UPDATE
                                 submit_title = VALUES(submit_title),
                                 memo        = VALUES(memo),

                                                   -- ✅ 파일을 새로 안 올리면 기존 파일 유지
                                 file_name   = IFNULL(VALUES(file_name), file_name),
                                 file_url    = IFNULL(VALUES(file_url), file_url),
                                 file_size   = IFNULL(VALUES(file_size), file_size),

                                                   -- ✅ 제출시각은 재제출해도 갱신하고 싶으면 유지
                                 submitted_at = CURRENT_TIMESTAMP
    </insert>

    <select id="selectCreatedByEmail" resultType="string">
        SELECT created_by_email
        FROM assignments
        WHERE assignment_id = #{assignmentId}
    </select>

    <delete id="deleteSubmissionsByAssignmentId">
        DELETE FROM assignment_submissions
        WHERE assignment_id = #{assignmentId}
    </delete>

    <delete id="deleteAssignmentByIdAndAuthor">
        DELETE FROM assignments
        WHERE assignment_id = #{assignmentId}
          AND created_by_email = #{authorEmail}
    </delete>



    <select id="selectSubmissionDetails"
            resultType="com.example.demo.assignment.dto.AssignmentSubmissionDetailResponse">

        SELECT
        s.submission_id AS submissionId,
        u.email AS userId,

        CONCAT(
            COALESCE(NULLIF(TRIM(m.request_user_nickname), ''), '방장'),
            '(',
            CASE
                WHEN CHAR_LENGTH(u.name) = 1 THEN u.name
                WHEN CHAR_LENGTH(u.name) = 2 THEN CONCAT(SUBSTRING(u.name, 1, 1), '*')
                ELSE CONCAT(SUBSTRING(u.name, 1, 1), REPEAT('*', CHAR_LENGTH(u.name) - 2), SUBSTRING(u.name, -1))
            END,
            ')'
        ) AS memberName,

        s.submitted_at AS submittedAt,

        CASE WHEN s.submission_id IS NULL THEN '미제출' ELSE '제출됨' END AS status,
        s.file_url AS fileUrl,
        s.file_name AS fileName

        FROM assignments a

        JOIN (
        /* HOST: 방장도 room_join_request 닉네임 우선, 없으면 room.hostUserNickname (출석부/채팅과 동일) */
        SELECT
            a1.room_id,
            r.host_user_email AS user_email,
            COALESCE(rjr.request_user_nickname, r.hostUserNickname) AS request_user_nickname,
            'HOST' AS role
        FROM assignments a1
        JOIN room r ON r.room_id = a1.room_id
        LEFT JOIN room_join_request rjr
            ON rjr.room_id = a1.room_id
               AND rjr.request_user_email = r.host_user_email
               AND TRIM(rjr.status) IN ('승인', '승인됨', 'APPROVED')
        WHERE a1.assignment_id = #{assignmentId}

        UNION ALL

        /* 승인 MEMBER */
        SELECT
            rjr.room_id,
            rjr.request_user_email AS user_email,
            rjr.request_user_nickname,
            'MEMBER' AS role
        FROM room_join_request rjr
        WHERE TRIM(rjr.status) IN ('승인', '승인됨', 'APPROVED')
          AND rjr.room_id = (SELECT room_id FROM assignments WHERE assignment_id = #{assignmentId})
          AND rjr.request_user_email NOT IN (
              SELECT host_user_email FROM room WHERE room_id = rjr.room_id
          )
        ) m ON m.room_id = a.room_id

        JOIN users u ON u.email = m.user_email

        LEFT JOIN assignment_submissions s
        ON s.assignment_id = a.assignment_id
        AND s.user_email = u.email

        WHERE a.assignment_id = #{assignmentId}

        ORDER BY
        (m.role = 'HOST') DESC,
        (s.submission_id IS NULL) ASC,
        s.submitted_at DESC,
        memberName ASC;


    </select>

    <select id="selectSubmissionFileBySubmissionId" resultType="com.example.demo.assignment.dto.AssignmentSubmissionFileDto">
        SELECT file_url AS fileUrl, file_name AS fileName
        FROM assignment_submissions
        WHERE submission_id = #{submissionId}
    </select>

    <select id="selectMatrixAssignments"
            resultType="com.example.demo.assignment.dto.AssignmentMatrixAssignment">
        SELECT
            a.assignment_id AS assignmentId,
            a.title AS title
        FROM assignments a
        WHERE a.room_id = #{roomId}
        ORDER BY a.due_at ASC, a.assignment_id ASC
    </select>


    <select id="selectMatrixRows"
            resultType="com.example.demo.assignment.dto.AssignmentMatrixRow">

        SELECT
            u.email AS userId,

            CONCAT(
                COALESCE(NULLIF(TRIM(m.request_user_nickname), ''), '방장'),
                '(',
                CASE
                    WHEN CHAR_LENGTH(u.name) = 1 THEN u.name
                    WHEN CHAR_LENGTH(u.name) = 2 THEN CONCAT(SUBSTRING(u.name, 1, 1), '*')
                    ELSE CONCAT(SUBSTRING(u.name, 1, 1), REPEAT('*', CHAR_LENGTH(u.name) - 2), SUBSTRING(u.name, -1))
                END,
                ')'
            ) AS memberName,

            a.assignment_id AS assignmentId,

            s.submission_id AS submissionId,
            s.submitted_at AS submittedAt,
            s.file_url AS fileUrl

        FROM assignments a

                 JOIN (
            /* HOST: 방장도 room_join_request 닉네임 우선, 없으면 room.hostUserNickname */
            SELECT
                r.room_id,
                r.host_user_email AS user_email,
                COALESCE(rjr.request_user_nickname, r.hostUserNickname) AS request_user_nickname,
                'HOST' AS role
            FROM room r
            LEFT JOIN room_join_request rjr
                ON rjr.room_id = r.room_id
                   AND rjr.request_user_email = r.host_user_email
                   AND TRIM(rjr.status) IN ('승인', '승인됨', 'APPROVED')
            WHERE r.room_id = #{roomId}

            UNION ALL

            /* 승인 MEMBER */
            SELECT
                rjr.room_id,
                rjr.request_user_email AS user_email,
                rjr.request_user_nickname,
                'MEMBER' AS role
            FROM room_join_request rjr
            WHERE rjr.room_id = #{roomId}
              AND TRIM(rjr.status) IN ('승인', '승인됨', 'APPROVED')
              AND rjr.request_user_email NOT IN (
                  SELECT host_user_email FROM room WHERE room_id = rjr.room_id
              )
        ) m ON m.room_id = a.room_id

                 JOIN users u ON u.email = m.user_email

                 LEFT JOIN assignment_submissions s
                           ON s.assignment_id = a.assignment_id
                               AND s.user_email = u.email

        WHERE a.room_id = #{roomId}

        ORDER BY
            (m.role = 'HOST') DESC,
            memberName ASC,
            a.due_at ASC,
            a.assignment_id ASC
    </select>









</mapper>
