<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.assignment.mapper.AssignmentMapper">

    <!-- 1) 과제 목록: 내 제출 여부로 status 만들기 -->
    <select id="selectAssignmentsByRoom" resultType="com.example.demo.assignment.dto.AssignmentListResponse">
        SELECT
            a.assignment_id AS assignmentId,
            a.title AS title,
            a.due_at AS dueAt,
            u.email AS authorEmail,
            CASE WHEN s.submission_id IS NULL THEN '제출 하기' ELSE '제출 완료' END AS status
        FROM assignments a
                 JOIN users u ON u.user_id = a.created_by_user_id
                 LEFT JOIN assignment_submissions s
                           ON s.assignment_id = a.assignment_id
                               AND s.user_id = #{userId}
        WHERE a.room_id = #{roomId}
        ORDER BY a.due_at ASC, a.assignment_id DESC;

    </select>


    <!-- 2) 과제 생성 -->
    <insert id="insertAssignment"
            parameterType="com.example.demo.assignment.vo.AssignmentVO"
            useGeneratedKeys="true"
            keyProperty="assignmentId">

        INSERT INTO assignments (room_id, title, description, due_at, created_by_user_id)
        VALUES (#{roomId}, #{title}, #{description}, #{dueAt}, #{createdByUserId})

    </insert>

    <!-- 3) 제출: (assignment_id, user_email) UNIQUE라서 중복제출이면 UPDATE -->
    <insert id="upsertSubmission" parameterType="com.example.demo.assignment.vo.AssignmentSubmissionVO">
        INSERT INTO assignment_submissions
        (assignment_id, user_id, submit_title, memo, file_name, file_url, file_size)
        VALUES
            (#{assignmentId}, #{userId}, #{submitTitle}, #{memo}, #{fileName}, #{fileUrl}, #{fileSize})
            ON DUPLICATE KEY UPDATE
                                 submit_title = VALUES(submit_title),
                                 memo        = VALUES(memo),
                                 file_name   = VALUES(file_name),
                                 file_url    = VALUES(file_url),
                                 file_size   = VALUES(file_size),
                                 submitted_at = CURRENT_TIMESTAMP
    </insert>

    <select id="selectSubmissionDetails"
            resultType="com.example.demo.assignment.dto.AssignmentSubmissionDetailResponse">
        SELECT
            u.user_id AS userId,

            /* 닉네임(이름마스킹) -> 예: 가나디(홍*동) */
            CONCAT(
                    rjr.request_user_nickname,
                    '(',
                    CASE
                        WHEN CHAR_LENGTH(u.name) = 1 THEN u.name
                        WHEN CHAR_LENGTH(u.name) = 2 THEN CONCAT(SUBSTRING(u.name, 1, 1), '*')
                        ELSE CONCAT(
                                SUBSTRING(u.name, 1, 1),
                                REPEAT('*', CHAR_LENGTH(u.name) - 2),
                                SUBSTRING(u.name, -1)
                             )
                        END,
                    ')'
            ) AS memberName,

            s.submitted_at AS submittedAt,

            CASE
                WHEN s.submission_id IS NULL THEN '미제출'
                ELSE '제출됨'
                END AS status,

            s.file_url AS fileUrl,
            s.file_name AS fileName

        FROM assignments a
                 /* 이 과제가 속한 room_id로 승인된 스터디원 목록 가져오기 */
                 JOIN room_join_request rjr
                      ON rjr.room_id = a.room_id
                          AND rjr.status = '승인'

                 JOIN users u
                      ON u.email = rjr.request_user_email

                 LEFT JOIN assignment_submissions s
                           ON s.assignment_id = a.assignment_id
                               AND s.user_id = u.user_id

        WHERE a.assignment_id = #{assignmentId}

        /* 제출됨 먼저, 제출시간 최신 순 */
        ORDER BY
            (s.submission_id IS NULL) ASC,
            s.submitted_at DESC,
            rjr.request_user_nickname ASC;
    </select>


</mapper>
