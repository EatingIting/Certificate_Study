<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.board.mapper.BoardPostMapper">

    <resultMap id="PostMap" type="com.example.demo.board.vo.BoardPostVO">
        <id     property="postId"       column="post_id"/>
        <result property="roomId"       column="room_id"/>
        <result property="userId"       column="user_id"/>
        <result property="nickname"     column="nickname"/>
        <result property="category"     column="category"/>
        <result property="title"        column="title"/>
        <result property="content"      column="content"/>
        <result property="isPinned"     column="is_pinned"/>
        <result property="viewCount"    column="view_count"/>
        <result property="createdAt"    column="created_at"/>
        <result property="updatedAt"    column="updated_at"/>
        <result property="deletedAt"    column="deleted_at"/>
        <result property="commentCount" column="comment_count"/>
    </resultMap>

    <select id="selectPostList" resultMap="PostMap">
        SELECT
            p.post_id,
            p.room_id,
            p.user_id,
            /* ✅ 스터디별 닉네임 규칙 적용 */
            COALESCE(rjr.request_user_nickname, r.hostUserNickname, NULLIF(u.nickname, ''), u.name) AS nickname,
            p.category,
            p.title,
            p.content,
            p.is_pinned,
            p.view_count,
            p.created_at,
            p.updated_at,
            p.deleted_at,
            (SELECT COUNT(*)
             FROM board_comments c
             WHERE c.post_id = p.post_id
               AND c.deleted_at IS NULL) AS comment_count
        FROM board_posts p
                 LEFT JOIN users u
                           ON u.user_id = p.user_id
                 LEFT JOIN room r
                           ON r.room_id = p.room_id
                 LEFT JOIN room_join_request rjr
                           ON rjr.room_id = p.room_id
                               AND rjr.request_user_email = u.email
                               AND rjr.status = '승인'
        WHERE p.deleted_at IS NULL
          AND p.room_id = #{roomId}
        <if test="category != null and category != ''">
            AND p.category = #{category}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (
            p.title LIKE CONCAT('%', #{keyword}, '%')
            OR p.content LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>
        ORDER BY p.is_pinned DESC, p.post_id DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="countPostList" resultType="int">
        SELECT COUNT(*)
        FROM board_posts
        WHERE deleted_at IS NULL
        AND room_id = #{roomId}
        <if test="category != null and category != ''">
            AND category = #{category}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (
            title LIKE CONCAT('%', #{keyword}, '%')
            OR content LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>
    </select>

    <select id="selectPostById" resultMap="PostMap">
        SELECT
            p.post_id,
            p.room_id,
            p.user_id,
            /* ✅ 스터디별 닉네임 규칙 적용 */
            COALESCE(rjr.request_user_nickname, r.hostUserNickname, NULLIF(u.nickname, ''), u.name) AS nickname,
            p.category,
            p.title,
            p.content,
            p.is_pinned,
            p.view_count,
            p.created_at,
            p.updated_at,
            p.deleted_at
        FROM board_posts p
                 LEFT JOIN users u
                           ON u.user_id = p.user_id
                 LEFT JOIN room r
                           ON r.room_id = p.room_id
                 LEFT JOIN room_join_request rjr
                           ON rjr.room_id = p.room_id
                               AND rjr.request_user_email = u.email
                               AND rjr.status = '승인'
        WHERE p.post_id = #{postId}
          AND p.deleted_at IS NULL
    </select>

    <update id="incrementViewCount">
        UPDATE board_posts
        SET view_count = view_count + 1
        WHERE post_id = #{postId}
          AND deleted_at IS NULL
    </update>

    <insert id="insertPost"
            parameterType="com.example.demo.board.vo.BoardPostVO"
            useGeneratedKeys="true" keyProperty="postId" keyColumn="post_id">
        INSERT INTO board_posts (room_id,
                                 user_id,
                                 category,
                                 title,
                                 content,
                                 is_pinned,
                                 view_count
        ) VALUES (#{roomId},
                  #{userId},
                  #{category},
                  #{title},
                  #{content},
        <choose>
            <when test="isPinned != null">#{isPinned}</when>
            <otherwise>0</otherwise>
        </choose>,
        0
        )
    </insert>

    <update id="updatePost" parameterType="com.example.demo.board.vo.BoardPostVO">
        UPDATE board_posts
        SET category = #{category},
            title    = #{title},
            content  = #{content},
            is_pinned = #{isPinned}
        WHERE post_id = #{postId}
          AND user_id = #{userId}
          AND deleted_at IS NULL
    </update>

    <update id="softDeletePost">
        UPDATE board_posts
        SET deleted_at = NOW()
        WHERE post_id = #{postId}
          AND user_id = #{userId}
          AND deleted_at IS NULL
    </update>

    <update id="updatePinned">
        UPDATE board_posts
        SET is_pinned = #{isPinned}
        WHERE post_id = #{postId}
          AND user_id = #{userId}
          AND deleted_at IS NULL
    </update>

    <!-- 공지글: 방장 전용 수정 (작성자(user_id) 조건 없음) -->
    <update id="updatePostByHost" parameterType="com.example.demo.board.vo.BoardPostVO">
        UPDATE board_posts
        SET
            title = #{title},
            content = #{content},
            is_pinned = #{isPinned}
        WHERE post_id = #{postId}
          AND deleted_at IS NULL
    </update>

    <!-- 공지글: 방장 전용 삭제 -->
    <update id="softDeletePostByHost">
        UPDATE board_posts
        SET deleted_at = NOW()
        WHERE post_id = #{postId}
          AND deleted_at IS NULL
    </update>

    <!-- 공지글: 방장 전용 고정 -->
    <update id="updatePinnedByHost">
        UPDATE board_posts
        SET is_pinned = #{isPinned}
        WHERE post_id = #{postId}
          AND deleted_at IS NULL
    </update>
    
    <select id="findWriterIdByPostId" resultType="string">
        SELECT user_id
        FROM board_posts
        WHERE post_id = #{postId}
          AND deleted_at IS NULL
    </select>

    <select id="findPostTitleByPostId" resultType="string">
        SELECT title
        FROM board_posts
        WHERE post_id = #{postId}
          AND deleted_at IS NULL
    </select>

    <select id="findRoomIdByPostId" resultType="string">
        SELECT room_id
        FROM board_posts
        WHERE post_id = #{postId}
          AND deleted_at IS NULL
    </select>


</mapper>